<html><head>
  <title>Check_MK 분석 1</title>
  <basefont face="맑은 고딕 Semilight" size="2">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="exporter-version" content="Evernote Windows/308474 (ko-KR, DDL); Windows/10.0.0 (Win64);">
  <style>
    body, td {
      font-family: 맑은 고딕 Semilight;
      font-size: 10pt;
    }
  </style>

    <link rel="stylesheet" href="Check_MK1_files/style.css">

   <!-- Global site tag (gtag.js) - Google Analytics -->
<script type="text/javascript" async="" src="Check_MK1_files/analytics.js"></script><script async="" src="Check_MK1_files/js"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-138982878-1');
</script>



<script src="Check_MK1_files/embed.js" data-timestamp="1557712731095"></script><link rel="prefetch" as="style" href="Check_MK1_files/a_data/lounge.css"><link rel="prefetch" as="script" href="Check_MK1_files/a_data/common.js"><link rel="prefetch" as="script" href="Check_MK1_files/a_data/lounge_002.js"><link rel="prefetch" as="script" href="Check_MK1_files/a_data/config.js"><script src="Check_MK1_files/alfalfa_min.js" async="" charset="UTF-8"></script></head>
<body>

  <h1 id="js_main"><a href="index.html" title="WEB Home">WEB - 코딩무료강의</a></h1>
  <div id="grid">
    <ol>
      <li><a href="1.html" class="saw">HTML</a></li>
      <li><a href="2.html" class="saw" id="active">CSS</a></li>
      <li><a href="3.html">JavasCript</a></li>
      <li><a href="Check_MK1.html">mod_python</a></li>
	  <li><a href="Check_MK2.html">plugin_init</a></li>
      <li><a href="Check_MK3.html">page_handlers</a></li>
    </ol>
    <div id="article">


<a name="16572">

</a><div><a name="16572">
</a><div><a name="16572"><span><div><span style="font-weight: bold;">Check_MK 분석 1</span></div><div><br></div><div>-&nbsp;<span style="font-weight: bold;">Check_MK 파이썬 홈페이지 구조 분석</span></div><div><br></div><div>Check_MK 화면은 mod_python, html, CSS, JavaScript, jquery, Ajax, cookie 등 다양한 기술이 사용되었다.</div><div>Python 은 서버 Site 에 사용되었고 HTML + CSS + JS 사용해서 브라우저에 동적인 Page 를 구현</div><div><br></div><div>서버 IP: 172.16.30.93 &nbsp; root/ibmkts1</div><div>RootDocument 위치: /omd/sites/sjopen/share/check_mk/web/htdocs</div><div>참고:</div><div>&nbsp; &nbsp;- /omd/sites/sjopen/share/check_mk/web/htdocs/index.py 파일이 index 이면서 .py 로 끝나는 &nbsp;모든 파일에 대한 핸들러임</div><div>&nbsp; &nbsp;- 서버싸이드 프로그램은 mod_python 이며 .py 로 끝나는 모든 요청을 index.py 핸들러 &nbsp;하나로 처리함.(test.py 요청해도 index.py 호출)</div><div>&nbsp;
 &nbsp;- 메인 페이지는 dashboard.py 와 side.py (2개의 프레임) 인데, dashboard.py 파일을
요청하면 &nbsp;dashboard.py 파일이 호출되는게 아니고 index.py?deshboard.py 형태로 처리됨</div><div>&nbsp; &nbsp;- index.py 는 HTML query 를 옵션으로 받아서 python 으로 HTML 문서 생성</div><div>&nbsp; &nbsp;- mod_python 메뉴얼: &nbsp;http://modpython.org/live/mod_python-3.3.1/doc-html/tut-what-it-do.html</div><div><br></div><div>n. CSS 사용예.</div><div>&lt;link rel="stylesheet" type="text/css" href="mystyle.css"&gt;</div></span></a><div><a name="16572"></a><a href="https://developer.mozilla.org/ko/docs/Learn/CSS/Introduction_to_CSS/How_CSS_works">https://developer.mozilla.org/ko/docs/Learn/CSS/Introduction_to_CSS/How_CSS_works</a></div><div>n. javascript 사용예.</div><div>&lt;script src="script.js"&gt;&lt;/script&gt;</div><div><br></div><div><span style="font-weight: bold;">n. Check_MK 가 사용하는 Apache config file 확인</span></div><div>- httpd 프로세스 옵션에서 apache config 파일 위치를 확인</div><div>- error_log 에서 mod_python/3.3.1 버전 및 Python/2.7 확인</div><div><br></div><div># ps -ef |grep http</div><div>sjopen
 &nbsp; 54273 30208 &nbsp;0 00:01 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:11
/usr/sbin/httpd -f /omd/sites/sjopen/etc/apache/apache.conf</div><div><br></div><div># cat /omd/sites/sjopen/var/log/apache/error_log</div><div>Apache/2.4.6 (CentOS) mod_python/3.3.1 Python/2.7.14 mod_fcgid/2.3.9 configured</div><div><br></div><div><span style="font-weight: bold;">n. apache.conf &nbsp;설정 분석</span></div><div><span style="font-family: 새굴림;"># vi /omd/sites/sjopen/etc/apache/apache.conf</span></div><div><span style="font-family: 새굴림;">DocumentRoot
 "/omd/sites/sjopen/var/www"&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp;==&gt; Public document root, 실제 파일은 하나도 없음</span></div><div><span style="font-family: 새굴림;">Include /omd/sites/sjopen/etc/apache/listen-port.conf&nbsp; &nbsp; ==&gt; Listen 127.0.0.1:5000</span></div><div><span style="font-family: 새굴림;">&nbsp;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(main apache
의&nbsp;/etc/httpd/conf.d/zzz_omd.conf 및 mod_proxy 모듈에 의해서 80 /sjopen
은&nbsp;</span><a href="http://127.0.0.1:5000/sjopen" style="font-family: 새굴림; color: rgb(227, 0, 0);">http://127.0.0.1:5000/sjopen</a><span style="font-family: 새굴림;">&nbsp;으로 Proxy)</span></div><div><br></div><div><span style="font-family: 새굴림;">Include /omd/sites/sjopen/etc/apache/conf.d/*.conf&nbsp; &nbsp; &nbsp; ==&gt; 추가적인 Configuration 파일들은 별도 파일에서 include</span></div><div><br></div><div><span style="font-family: 새굴림;"># ls /omd/sites/sjopen/etc/apache/conf.d/*.conf</span></div><div><span style="font-family: 새굴림;">/omd/sites/sjopen/etc/apache/conf.d/01_python.conf&nbsp;
 &nbsp; &nbsp;==&gt; LoadModule python_module &nbsp;mod_python.so 파이썬 모듈
 apache 에 로드</span></div><div><span style="font-family: 새굴림;">/omd/sites/sjopen/etc/apache/conf.d/02_fcgid.conf</span></div><div><span style="font-family: 새굴림;">/omd/sites/sjopen/etc/apache/conf.d/auth.conf&nbsp;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ==&gt; AuthUserFile
/omd/sites/sjopen/etc/htpasswd</span></div><div><span style="font-family: 새굴림;">/omd/sites/sjopen/etc/apache/conf.d/check_mk.conf&nbsp;
 &nbsp; &nbsp; ==&gt; Alias /sjopen/check_mk&nbsp;
&nbsp;/omd/sites/sjopen/share/check_mk/web/htdocs, 메인 Site 설정</span></div><div><span style="font-family: 새굴림;">/omd/sites/sjopen/etc/apache/conf.d/cookie_auth.conf</span></div><div><span style="font-family: 새굴림;">/omd/sites/sjopen/etc/apache/conf.d/dokuwiki.conf</span></div><div><span style="font-family: 새굴림;">/omd/sites/sjopen/etc/apache/conf.d/icinga.conf</span></div><div><span style="font-family: 새굴림;">/omd/sites/sjopen/etc/apache/conf.d/nagios.conf</span></div><div><span style="font-family: 새굴림;">/omd/sites/sjopen/etc/apache/conf.d/nagvis.conf</span></div><div><span style="font-family: 새굴림;">/omd/sites/sjopen/etc/apache/conf.d/omd.conf</span></div><div><span style="font-family: 새굴림;">/omd/sites/sjopen/etc/apache/conf.d/pnp4nagios.conf</span></div><div><span style="font-family: 새굴림;">/omd/sites/sjopen/etc/apache/conf.d/site.conf</span></div><div><span style="font-family: 새굴림;">/omd/sites/sjopen/etc/apache/conf.d/stats.conf</span></div><div><span style="font-family: 새굴림;">/omd/sites/sjopen/etc/apache/conf.d/var_www.conf&nbsp;
 &nbsp; &nbsp; &nbsp; =&gt; Alias /sjopen "/omd/sites/sjopen/var/www"
=&gt; public document root 설정</span></div><div><span style="font-family: 새굴림;">N. /omd/sites/sjopen/etc/apache/conf.d/*.conf&nbsp; 파일 분석</span></div><div><br></div><div><span style="font-weight: bold;">n. mod_python 모듈을 Apache 에 추가</span></div><div>/omd/sites/sjopen/etc/apache/conf.d/01_python.conf</div><div>&lt;IfModule !mod_python.c&gt;</div><div>&nbsp;LoadModule python_module /omd/sites/sjopen/lib/apache/modules/mod_python.so</div><div>&lt;/IfModule&gt;</div><div>&nbsp; # Mod_python is an Apache module that embeds the Python interpreter within the server.</div><div><br></div><div><a href="http://modpython.org/live/mod_python-3.3.1/doc-html/tut-what-it-do.html">http://modpython.org/live/mod_python-3.3.1/doc-html/tut-what-it-do.html</a></div><div><br></div><div><br></div><div><span style="font-weight: bold;">n. mod_python 핸들러 설정(/sjopen/check_mk 경로에 대한 요청을 처리하는 방법)</span></div><div><br></div><div><span style="font-family: 바탕체;">/omd/sites/sjopen/etc/apache/conf.d/check_mk.conf</span></div><div><span style="font-family: 바탕체;">&nbsp;Alias /sjopen/check_mk /omd/sites/sjopen/share/check_mk/web/htdocs</span></div><div><span style="font-family: 바탕체;">&nbsp;&lt;Directory /omd/sites/sjopen/share/check_mk/web/htdocs&gt;</span></div><div><span style="font-family: 바탕체;">&nbsp;
 &nbsp; &nbsp; &nbsp;AddHandler mod_python .py&nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; ==&gt; py로 끝나는 파일은 mod_python 으로 처리한다는 지시어</span></div><div><span style="font-family: 바탕체;">&nbsp;
 &nbsp; &nbsp; &nbsp;PythonHandler index&nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; ==&gt; main request handler, index 모듈 임포트,
index.py 모듈에서 handler 함수를 호출</span></div><div><span style="font-family: 바탕체;">&nbsp;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; (PythonHandler -&gt; handler), handler 호출 및 request object
 전달</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp;
&nbsp; &nbsp;PythonOption mod_python.importer.path
"['/omd/sites/sjopen/local/share/check_mk/web/htdocs',
'/omd/sites/sjopen/share/check_mk/web/htdocs']"</span></div><div><span style="font-family: 바탕체;">&nbsp;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
==&gt; 모듈을 검색하는 순서, apache.import_module() function is called with just
the name of the module.</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp;DirectoryIndex index.py&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ==&gt; 클라이언트가 디렉토리를 요청할때 찾아볼 자원</span></div><div><br></div><div><br></div><div><span style="font-weight: bold;">n. mod_python 핸들러</span></div><div>-
 Apache는 일반적인 요청은 3단계 Phase로 나줘서 처리한다. (1) translate the requested URI
to a file location (2) read the file and send it to the client, then (3)
 log the request.</div><div>- Apache가 처리하는 각각의 단계를 "핸들러(handler)"라고 한다.</div><div>- 특별한 처리가 필요한 요청은 additional handler 추가를 통해서 다르게 처리할 수 있다.</div><div><br></div><div>- AddHandler 설정은 .py 확장자로 끝나는 요청은 mod_python handler 로 처리해야 한다는 설정</div><div>- PythonHandler 설정은 핸들러 설정이며 Python??Handler 형태를 통해서 handler를 지정하고 원하는 동작을 할 수 있다.</div><div>- PythonHandler 는 중간에 아무것도 없어서 이름이 없는 핸들러이며 generic handler 라고 부른다.</div><div>- PythonHandler index 설정은 /sjopen/check_mk/*.py 확장자로 들어오는 요청은 generic handler 처리를 index.py로 처리한다는 의미다.</div><div>- *.py 로 들어오는 요청은 index.py 내부 handler() 함수가 generic handler로써 호출하고 request object 를 전달한다.(파일 존재 여부와 관계없다)</div><div>- request object (req) 는 http 요청에 대한 모든 정보를 가지고 있다.(client IP, header, URI, etc)</div><div><br></div><div>&gt; <a href="http://modpython.org/live/current/doc-html/tutorial.html">http://modpython.org/live/current/doc-html/tutorial.html</a></div><div><br></div><div><img src="Check_MK1_files/Image.gif" type="image/gif" data-filename="Image.gif" title="눌러서 다운로드" width="572">&nbsp; <img src="Check_MK1_files/Image%25201.gif" type="image/gif" data-filename="Image.gif" title="눌러서 다운로드" width="490"></div><div><br></div><div><a href="http://modpython.org/live/mod_python-3.3.1/doc-html/tut-what-it-do.html">http://modpython.org/live/mod_python-3.3.1/doc-html/tut-what-it-do.html</a></div><div><br></div><div><br></div><div><span style="font-weight: bold;">n. index.py 파일의 handler 함수 분석</span></div><div><span style="font-weight: bold;">(PythonHandler index 설정에 의해서 호출되는 파일)</span></div><div><br></div><div><span style="font-family: 바탕체;">/omd/sites/sjopen/share/check_mk/web/htdocs/index.py</span></div><div><span style="font-family: 바탕체;">#!/usr/bin/python</span></div><div><span style="font-family: 바탕체;">-*- encoding: utf-8; py-indent-offset: 4 -*-</span></div><div><span style="font-family: 바탕체;"># +------------------------------------------------------------------+</span></div><div><span style="font-family: 바탕체;">#
 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ____ _ &nbsp; &nbsp; &nbsp;
 &nbsp; &nbsp; &nbsp; &nbsp; _&nbsp; &nbsp; &nbsp; &nbsp; __ &nbsp;__ _
&nbsp;__ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</span></div><div><span style="font-family: 바탕체;">#
 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/ ___| |__ &nbsp; ___
&nbsp;___| | __ &nbsp; |&nbsp; \/ &nbsp;| |/ / &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; |</span></div><div><span style="font-family: 바탕체;"># |
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | | &nbsp; | '_ \ / _ \/ __| |/ /
&nbsp; | |\/| | ' / &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|</span></div><div><span style="font-family: 바탕체;">#
 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | |___| | | | &nbsp;__/ (__|
&nbsp; &lt; &nbsp; &nbsp;| | &nbsp;| | . \ &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp;|</span></div><div><span style="font-family: 바탕체;"># |
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\____|_|
|_|\___|\___|_|\_\___|_| &nbsp;|_|_|\_\ &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; |</span></div><div><span style="font-family: 바탕체;"># | &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp;|</span></div><div><span style="font-family: 바탕체;"># | Copyright Mathias Kettner 2014 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span> <a dir="ltr" href="mailto:mk@mathias-kettner.de" style="font-family: 바탕체; color: rgb(227, 0, 0);">mk@mathias-kettner.de</a> <span style="font-family: 바탕체;">|</span></div><div><span style="font-family: 바탕체;"># +------------------------------------------------------------------+</span></div><div><br></div><div><span style="font-family: 바탕체;">from mod_python import apache</span></div><div><span style="font-family: 바탕체;">import sys, os, pprint, __builtin__&nbsp; &nbsp; ==&gt; 파이썬 표준 라이브러리에 포함된 모듈,</span> <span style="font-family: 바탕체; font-weight: bold;">__builtin__</span> <span style="font-family: 바탕체;">module provides direct access to all‘built-in’identifiers of Python</span></div><div><span style="font-family: 바탕체;">import traceback&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;==&gt; 파이썬 표준 라이브러리에 포함된 모듈</span></div><div><br></div><div><span style="font-family: &quot;맑은 고딕&quot;;">#&nbsp; Check_MK 에서 설치한 파이썬 모듈 및 함수들 임포트 (/omd/sites/sjopen/share/check_mk/web/htdocs 아래)</span></div><div><span style="font-family: 바탕체;">import i18n</span></div><div><span style="font-family: 바탕체;">import sites</span></div><div><span style="font-family: 바탕체;">import livestatus</span></div><div><span style="font-family: 바탕체;">import modules</span></div><div><span style="font-family: 바탕체;">import userdb</span></div><div><span style="font-family: 바탕체;">import config</span></div><div><span style="font-family: 바탕체;">import login</span></div><div><span style="font-family: 바탕체;">from lib import *</span></div><div><span style="font-family: 바탕체;">import log</span></div><div><span style="font-family: 바탕체;">from html_mod_python import html_mod_python, FinalizeRequest</span></div><div><span style="font-family: 바탕체;">import cmk.paths&nbsp; &nbsp; &nbsp;==&gt; /opt/omd/versions/1.5.0p13.cre/lib/python/cmk/paths.py</span></div><div><br></div><div><span style="font-family: 바탕체;"># Main entry point for all HTTP-requests (called directly by mod_apache)</span></div><div><span style="font-family: 바탕체; font-weight: bold;">def handler(mod_python_req, fields = None, is_profiling = False):</span><span style="font-family: 바탕체;">&nbsp;</span> <span style="font-family: &quot;맑은 고딕&quot;;">==&gt; &nbsp;</span><span style="font-family: &quot;맑은 고딕&quot;; font-weight: bold;">.py</span> <span style="font-weight: bold; font-family: &quot;맑은 고딕&quot;;">핸들러가 호출하는 함수</span> <span style="font-family: &quot;맑은 고딕&quot;; font-weight: bold;">handler</span> <span style="font-family: &quot;맑은 고딕&quot;; font-weight: bold;">("PythonHandler" 에서 Python 빼고 "handler"가 호출됨)</span></div><div><span style="color: rgb(227, 0, 0); font-family: 바탕체;">&nbsp; &nbsp;# Create an object that contains all data about the request and</span></div><div><span style="color: rgb(227, 0, 0); font-family: 바탕체;">&nbsp; &nbsp;# helper functions for creating valid HTML. Parse URI and</span></div><div><span style="color: rgb(227, 0, 0); font-family: 바탕체;">&nbsp; &nbsp;# store results in the request object for later usage.</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp;__builtin__.html = html_mod_python(mod_python_req, fields)&nbsp; &nbsp; &nbsp; &nbsp;</span> <span style="font-family: &quot;맑은 고딕&quot;;">==&gt; html 인스턴스 생성 html_mod_python</span> <a href="https://edu.goorm.io/learn/lecture/202/%EB%B0%94%EB%A1%9C-%EC%8B%A4%ED%96%89%ED%95%B4%EB%B3%B4%EB%A9%B4%EC%84%9C-%EB%B0%B0%EC%9A%B0%EB%8A%94-%ED%8C%8C%EC%9D%B4%EC%8D%AC/lesson/26672/%ED%81%B4%EB%9E%98%EC%8A%A4%EB%9E%80" style="font-family: &quot;맑은 고딕&quot;; color: rgb(227, 0, 0);">클래스</a> <span style="font-family: &quot;맑은 고딕&quot;;">(html 클래스 상속)</span></div><div><br></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp;response_code = apache.OK</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp;try:</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp;config.initialize()&nbsp; &nbsp;</span> <span style="font-family: &quot;맑은 고딕&quot;;">==&gt; multisite.mk 및 multisite.d/*.mk 불러옴(include)</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp;init_profiling(is_profiling)</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp;html.init_modes()&nbsp; &nbsp; &nbsp;</span> <span style="font-family: &quot;맑은 고딕&quot;;">==&gt; Initializes the operation mode of the html() object.</span></div><div><br></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp;# Make sure all plugins are avaiable as early as possible. At least</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp;# we need the plugins (i.e. the permissions declared in these) at the</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp;# time before the first login for generating auth.php.</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp;modules.load_all_plugins()</span></div><div><br></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp; # Get page handler.</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp; handler = modules.get_handler(html.myfile, page_not_found)&nbsp;</span> <span style="font-family: &quot;맑은 고딕&quot;;">==&gt; myfile(.py빼고 filename만)을 pagehandlers 딕셔너리에서 검색, 없으면 page_not_found</span></div><div><span style="font-family: &quot;맑은 고딕&quot;;">&nbsp;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; ==&gt; pagehandlers 딕셔너리는 modules.py 모듈에 있고
modules.init_modules() 및</span></div><div><span style="font-family: &quot;맑은 고딕&quot;;">&nbsp;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp;pagehandlers.update(pagetypes.page_handlers()) 에 의해서 pagetypes.py 의
 page_handlers 가 목록을 만듬(??)</span></div><div><br></div><div><br></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp;# Some pages do skip authentication. This is done by adding</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp;# noauth: to the page hander, e.g. "noauth:run_cron" : ...</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp;# TODO: Eliminate those "noauth:" pages. Eventually replace it by call using</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp;# &nbsp; &nbsp; &nbsp; the now existing default automation user.</span></div><div><span style="font-family: 바탕체;">&nbsp;
 &nbsp; &nbsp; &nbsp;if handler == page_not_found:&nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp;</span> <span style="font-family: &quot;맑은 고딕&quot;;">==&gt; 만약 page_not_found 발생하면 noauth 방식으로 재시도</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;handler = modules.get_handler("noauth:" + html.myfile, page_not_found)</span></div><div><span style="font-family: 바탕체;">&nbsp;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if handler != page_not_found:&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp;&nbsp;</span><span style="font-family: &quot;맑은 고딕&quot;;">==&gt; <span style="font-family: &quot;맑은 고딕&quot;; color: rgb(54, 101, 238);">만약 page_not_found 아니면 handler() 호출(반환된 page handler 이름으로, 왜 이름이 같을까??)</span></span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;try:</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;handler()&nbsp; &nbsp;</span> <span style="font-family: &quot;맑은 고딕&quot;;">==&gt; URL 에서 호출한 핸들러 실행(EX: view)</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;except Exception, e:</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;html.write_text("%s" % e)</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if config.debug:</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;html.write_text(traceback.format_exc())</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;raise FinalizeRequest()</span></div><div><span style="font-weight: bold; font-family: 바탕체;">&lt;생략&gt;</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp;# All plugins might have to be reloaded due to a language change. Only trigger</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp;# a second plugin loading when the user is really using a custom localized GUI.</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp;# Otherwise the load_all_plugins() at the beginning of the request is sufficient.</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp;if i18n.get_current_language() != previous_language:</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;modules.load_all_plugins()</span></div><div><br></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp;ensure_general_access()</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp;handler()</span></div><div><br></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp;# Get page handler.</span></div><div><span style="font-family: 바탕체;">&nbsp;
 &nbsp; &nbsp; &nbsp;handler = modules.get_handler(html.myfile,
page_not_found)&nbsp; ==&gt; &nbsp;return pagehandlers.get(name, dflt)</span></div><div><br></div><div><span style="font-weight: bold;">&lt;생략&gt;</span></div><div><br></div><div># Early initialization upon first start of the application by the server</div><div>def initialize():</div><div>&nbsp; &nbsp;init_sys_path()</div><div>&nbsp;
 &nbsp;log.init_logging()&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp;==&gt; web.log 에 기록하도록 logger를
초기화(/opt/omd/sites/sjopen/var/log/web.log)</div><div>&nbsp;
&nbsp;modules.init_modules()&nbsp; ==&gt; modules.py 모듈에 정의된
init_modules 펑션 수행 : Loads all modules needed into memory and performs
global initializations</div><div><br></div><div># Run the global application initialization code here. It is called</div><div># only once during the startup of the application server.</div><div>initialize()</div><div><br></div><div># Early initialization 절차 분석</div><div>index.py
 -&gt; initialize() -&gt; modules.py -&gt; init_modules -&gt;
load_web_plugins('pages', globals()) -&gt; lib.py -&gt;
load_web_plugins(forwhat, globalvars): -&gt; "/plugins/pages" 파일을
execfile() 하는것같음(<a href="evernote:///view/4527709/s42/a4f95732-6f9e-452e-bbbe-18e7d67e37b2/a4f95732-6f9e-452e-bbbe-18e7d67e37b2/">따로분석하자</a>)</div><div><br></div><div><span style="font-weight: bold;">n. Check_MK 메인 화면 분석</span></div><div>/sjopen/check_mk/ 접속하면 자동으로 index.py 옵션으로 start_url=dashboard.py 호출됨</div><div><a dir="ltr" href="http://172.16.30.93/sjopen/check_mk/index.py?start_url=%2Fsjopen%2Fcheck_mk%2Fdashboard.py">http://172.16.30.93/sjopen/check_mk/index.py?start_url=%2Fsjopen%2Fcheck_mk%2Fdashboard.py</a></div><div><img src="Check_MK1_files/Image.png" type="image/png" data-filename="Image.png" title="눌러서 다운로드" width="854"></div><div><br></div><div><a href="http://172.16.30.93/sjopen/check_mk/view.py?view_name=allhosts">http://172.16.30.93/sjopen/check_mk/view.py?view_name=allhosts</a></div><div><a href="http://172.16.30.93/sjopen/check_mk/view.py?host=sjopen1&amp;site=sjopen&amp;view_name=host">http://172.16.30.93/sjopen/check_mk/view.py?host=sjopen1&amp;site=sjopen&amp;view_name=host</a></div><div><br></div><div><br></div><div><span style="font-weight: bold;">n. CSS 파을은 어떻게 불러오나?</span></div><div>- 브라우저에서 확인한 CSS 경로는 다음과 같다.</div><div>&nbsp; &nbsp; &nbsp;<a href="http://172.16.30.93/sjopen/check_mk/check_mk-1.4.0p33.css">http://172.16.30.93/sjopen/check_mk/check_mk-1.4.0p33.css</a></div><div>- 실제 파일 이름은 check_mk.css 인데 check_mk-1.4.0p33.css 로 변경되서 불러온다.</div><div>- 아래 html_mod_python.py 모듈의 css_filename_for_browser 함수에서 파일명에 버전 정보를 넣어서 반환 하는것 같다.</div><div>- css_filename_for_browser 함수는 htmllib.py 와 html_mod_python.py 2곳에서 정의되었다.(메서드 오버라이드 인가??)</div><div><br></div><div># vi /omd/sites/sjopen/share/check_mk/web/htdocs/html_mod_python.py</div><div><br></div><div>&nbsp; &nbsp;def css_filename_for_browser(self, css):</div><div>&nbsp; &nbsp; &nbsp; &nbsp;rel_path = "/share/check_mk/web/htdocs/" + css + ".css"</div><div>&nbsp; &nbsp; &nbsp; &nbsp;if os.path.exists(cmk.paths.omd_root + rel_path) or \</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;os.path.exists(cmk.paths.omd_root + "/local" + rel_path):</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return '%s-%s.css' % (css, cmk.__version__)</div><div><br></div><div><br></div><div><span style="font-weight: bold;">n. 몇몇 모듈에 대한 분석</span></div><div>/omd/sites/sjopen/share/check_mk/web/htdocs/html_mod_python.py</div><div>&nbsp;
 &nbsp; &nbsp; &nbsp;=&gt;&nbsp; Request 를 분석하고 URL 해석해서 page name 확인하는
기능? We strip away the .py and get the name of the page., 모바일, degug</div><div>&nbsp; &nbsp; &nbsp; &nbsp;=&gt;&nbsp; def javascript_filename_for_browser(self, jsname):</div><div>/omd/sites/sjopen/share/check_mk/web/htdocs/htmllib.py&nbsp;
 &nbsp;=&gt; HTML encoding, def html_head(), def body_start() HTML 문서
만드는 Class, 함수들</div><div>/omd/sites/sjopen/share/check_mk/web/htdocs/views.py</div><div>[root@dev93 htdocs]# ls -l *html*</div><div>-rw-r--r--. 1 root root 102263 May 17 &nbsp;2018 htmllib.py</div><div>-rw-r--r--. 1 root root &nbsp;12250 May 17 &nbsp;2018 html_mod_python.py</div><div><br></div><div><span style="font-weight: bold;">n. 참고문헌</span></div><div>What is Mod_python?&nbsp;&nbsp;</div><div>&nbsp; &nbsp; &nbsp;Apache module that embeds the Pyhton interpreter</div><div><a href="http://math.uni.lodz.pl/~kowalcr/SLWP/Python3/CGI%20scripts%20in%20Python%20and%20mod_python.pdf">http://math.uni.lodz.pl/~kowalcr/SLWP/Python3/CGI%20scripts%20in%20Python%20and%20mod_python.pdf</a></div><div><br></div><div>mod_python 공식 온라인 메뉴얼</div><div><a href="http://modpython.org/live/mod_python-3.3.1/doc-html/module-apache.html">http://modpython.org/live/mod_python-3.3.1/doc-html/module-apache.html</a></div><div><br></div><div>Mod python notes</div><div><a href="https://helpful.knobs-dials.com/index.php/Mod_python_notes">https://helpful.knobs-dials.com/index.php/Mod_python_notes</a></div><div><br></div><div>Notepad++ 로 파이썬 개발 및 실행하기</div><div><a href="https://guslabview.tistory.com/344">https://guslabview.tistory.com/344</a></div><div><br></div><div><span style="font-weight: bold;">Apache와 Python 연동하기(한글)</span></div><div><a href="https://blog.ayukawa.kr/archives/1342">https://blog.ayukawa.kr/archives/1342</a></div><div><br></div><div>mod_python 핸들러 설명 &gt; PythonHandler</div><div><a href="https://m.blog.naver.com/PostView.nhn?blogId=mtjeaids&amp;logNo=70081082872&amp;proxyReferer=https%3A%2F%2Fwww.google.com%2F">https://m.blog.naver.com/PostView.nhn?blogId=mtjeaids&amp;logNo=70081082872&amp;proxyReferer=https%3A%2F%2Fwww.google.com%2F</a></div><div><br></div><div>파이썬 표준 라이브러리 - 어떤것이 있는지 찾아본다.</div><div><a href="https://docs.python.org/3/library/">https://docs.python.org/3/library/</a></div><div><br></div><div>표준은 아니지만 쓸만한 파이썬 패키지 검색, Find, install and publish Python packages with the Python Package Index</div><div>설치는 pip, setuptools, wheel 사용</div><div><a href="https://pypi.org/">https://pypi.org/</a></div><div><br></div><div><br></div><div><span style="font-weight: bold;">n. OMD public page 에서 mod_python 사용하도록 설정해서 테스트 -&gt; OK</span></div><div><span style="font-family: 바탕체;">vi /omd/sites/sjopen/etc/apache/conf.d/var_www.conf</span></div><div><span style="font-family: 바탕체;">Alias /sjopen "/omd/sites/sjopen/var/www"</span></div><div><span style="font-family: 바탕체;">&lt;Directory /omd/sites/sjopen/var/www&gt;</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp;Options +Indexes +FollowSymlinks</span></div><div><span style="font-family: 바탕체;"># sjjslee 2019.04.10 for test</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp;AddHandler mod_python .py</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp;PythonHandler index</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp;DirectoryIndex index.py</span></div><div><span style="font-family: 바탕체;"># sjlslee</span></div><div><span style="font-family: 바탕체;">&lt;/Directory&gt;</span></div><div><br></div><div><span style="font-weight: bold;">n. mod_python 테스트 프로그램 -&gt; OK</span></div><div><span style="font-family: 바탕체;"># vi /omd/sites/sjopen/var/www/index.py</span></div><div><span style="font-family: 바탕체;">from mod_python import apache&nbsp; &nbsp;</span> <span style="font-family: &quot;맑은 고딕&quot;;"># 모든 mod_python 프로그램 필요, 함수명 만으로 모듈내부 함수를 사용하도록 모듈 임포트</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span> <span style="font-family: &quot;맑은 고딕&quot;;">&nbsp;# mod_python 패키지의 apache 모듈, Apache interal 접근을 위한 인터페이스(m</span><a href="http://modpython.org/live/mod_python-3.3.1/doc-html/module-apache.html" style="font-family: &quot;맑은 고딕&quot;;">od_python manual</a><span style="font-family: &quot;맑은 고딕&quot;;">)</span></div><div><span style="font-family: 바탕체;">def handler(req):</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp;req.send_http_header()</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp;req.write("Hello World!\n")</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp;req.write("req.connection %s\n" % req.connection)</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp;req.write("req.server %s\n" % req.server)</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp;req.write("req.interpreter %s\n" % req.interpreter)</span></div><div><span style="font-family: 바탕체;">&nbsp; &nbsp;return apache.OK</span></div><div><br></div><div><img src="Check_MK1_files/Image%25201.png" type="image/png" data-filename="Image.png" title="눌러서 다운로드" width="508"></div><div><br></div><div><a href="https://wikidocs.net/29">https://wikidocs.net/29</a>&nbsp; &nbsp;=&gt;&nbsp; 파이썬 모듈 사용법</div><div><br></div><div><br></div><div>n. Ajax(Asynchronous JavaScript and XML) 구조</div><div>브라우저가 가지고있는 XMLHttpRequest 객체를 이용해서 전체 페이지를 새로 고치지 않고도 페이지의 일부만을 위한 데이터를 로드하는 기법</div><div>Ajax를 한마디로 정의하자면 JavaScript를 사용한 비동기 통신, 클라이언트와 서버간에 XML 데이터를 주고받는 기술</div><div><br></div><div><img src="Check_MK1_files/Image%25202.png" type="image/png" data-filename="Image.png" title="눌러서 다운로드"> <img src="Check_MK1_files/Image.jpg" type="image/jpeg" data-filename="Image.jpg" title="눌러서 다운로드"></div><div><br></div><div><br></div><div><br></div><div><span style="font-weight: bold;">n. index.py 파일 handler 분석</span></div><div><span style="font-weight: bold;">(PythonHandler index 에 의해서 호출되는 파일)</span></div><div><br></div><div># vi /omd/sites/sjopen/share/check_mk/web/htdocs/index.py</div><div><br></div><div>from mod_python import apache</div><div>def handler(req):&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;==&gt; 핸들러가 호출하는 함수 선언 ("PythonHandler " 에서 Python 빼고 "handler"가 호출됨)</div><div>&nbsp; &nbsp;req.content_type = "text/plain"</div><div>&nbsp; &nbsp;req.write("Hello World!")</div><div>&nbsp; &nbsp;return apache.OK</div><div><br></div><div>n. /sjopen/ 으로 요청하면 /site/omd/ 로 리다이렉트</div><div>/omd/sites/sjopen/etc/apache/conf.d/omd.conf</div><div><br></div><div>RewriteRule ^/sjopen/?$ %{ENV:proto}://%{SERVER_NAME}/sjopen/omd/ [R=302]</div><div><br></div><div>Alias /sjopen/omd "/omd/sites/sjopen/share/omd/htdocs"</div><div><br></div><div>&lt;Directory "/omd/sites/sjopen/share/omd/htdocs"&gt;</div><div><br></div><div>&nbsp;&lt;IfModule mod_python.c&gt;</div><div>&nbsp; &nbsp;AddHandler mod_python .py</div><div>&nbsp; &nbsp;PythonHandler index</div><div>&nbsp; &nbsp;# Make sure each site uses it's own Python interpreter (module cache!)</div><div>&nbsp; &nbsp;PythonInterpreter sjopen</div><div>&nbsp; &nbsp;PythonDebug On</div><div>&nbsp; &nbsp;DirectoryIndex index.py</div><div>&nbsp;&lt;/IfModule&gt;</div><div><br></div><div>&nbsp;Options FollowSymLinks</div><div>&nbsp;AllowOverride None</div><div>&lt;/Directory&gt;</div><div><br></div><div>- Public Document 에 대한 설정</div><div>Alias /sjopen "/omd/sites/sjopen/var/www"&nbsp; ==&gt; 이 디렉토리에는 파일이 하나도 없음</div><div><br></div><div><br></div>
<div>- 결국 check_mk URL을 호출하면 apache는 아래의 index.py 파일을 실행해서 Client 요청을 처리한다.</div>
</div>
  </div>



<div id="disqus_thread"><iframe id="dsq-app6571" name="dsq-app6571" allowtransparency="true" scrolling="no" tabindex="0" title="Disqus" style="width: 1px !important; min-width: 100% !important; border: medium none !important; overflow: hidden !important; height: 376px !important;" src="Check_MK1_files/a.html" horizontalscrolling="no" verticalscrolling="no" width="100%" frameborder="0"></iframe><iframe id="indicator-north" name="indicator-north" allowtransparency="true" scrolling="no" tabindex="0" title="Disqus" style="width: 873px !important; border: medium none !important; overflow: hidden !important; top: 0px !important; min-width: 873px !important; max-width: 873px !important; position: fixed !important; z-index: 2147483646 !important; height: 18px !important; min-height: 18px !important; max-height: 18px !important; display: none !important;" frameborder="0"></iframe><iframe id="indicator-south" name="indicator-south" allowtransparency="true" scrolling="no" tabindex="0" title="Disqus" style="width: 873px !important; border: medium none !important; overflow: hidden !important; bottom: 0px !important; min-width: 873px !important; max-width: 873px !important; position: fixed !important; z-index: 2147483646 !important; height: 18px !important; min-height: 18px !important; max-height: 18px !important; display: none !important;" frameborder="0"></iframe></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://web2-cvwyjcqaye.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



</div></div><iframe style="display: none;"></iframe></body></html>
